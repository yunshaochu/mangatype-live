"id","priority","phase","area","title","description","acceptance_criteria","test_mcp","review_initial_requirements","review_regression_requirements","dev_state","review_initial_state","review_regression_state","git_state","owner","refs","notes"
"APRSM-000","P0","1","both","固化重构边界与验收基线","以 Report 第7节为准建立重构边界，限定仅覆盖翻译任务 endpoint 保护链路，不改动 inpaint/scan。","产出可审阅的边界清单并被团队确认；翻译链路外功能回归用例 0 失败；验收口径明确引用 Report 第7节。","AUTOE2E","确认边界文档已包含不改动模块列表、灰度范围与回滚触点。","执行翻译+inpaint+scan 冒烟回归，验证非目标链路行为与重构前一致。","已完成","已完成","已完成","已提交","","D:\A1\mangatype-live\Report.md:7;D:\A1\mangatype-live\plan\2026-03-01_16-30-00-report-reducer-state-machine.md:1;D:\A1\mangatype-live\plan\2026-03-01_16-30-00-report-reducer-state-machine-boundary.md:1","picked_reason:P0 phase1 baseline first to lock scope and avoid non-target regressions;review_initial:boundary doc includes non-target module list, rollout scope and rollback touchpoints;validation_limited:interactive translate/inpaint/scan smoke cannot run in current CLI-only environment;manual_test:1) npm run dev 2) run translate queue and verify protection path 3) run inpaint and scan smoke and confirm behavior unchanged;evidence:added boundary baseline document and npm run build passed;risk:low docs-only and no runtime behavior change;done_at:2026-03-01"
"APRSM-010","P0","2","backend","扩展 APIEndpoint 状态字段与持久化兼容","在 APIEndpoint 模型新增保护状态字段并实现旧配置自动补默认值，保证 localStorage 向后兼容。","旧配置加载无报错；新增字段默认值完整；重复初始化结果幂等；旧用户配置不丢失且可继续翻译。","AUTOSERVER","检查类型定义、序列化/反序列化路径和默认值常量单一来源，禁止散落硬编码。","对含缺失字段、脏字段、完整字段三类样本执行加载回归，确保结果一致且无抖动。","已完成","已完成","已完成","已提交","","D:\A1\mangatype-live\types.ts:1;D:\A1\mangatype-live\contexts\ProjectContext.tsx:1;D:\A1\mangatype-live\plan\2026-03-01_16-30-00-report-reducer-state-machine.md:9","picked_reason:P0 foundational data model and persistence compatibility unblock all downstream reducer/event work;review_initial:added single-source endpoint defaults and normalization helper, wired into default endpoint, migration load path and update merge path;validation_limited:no automated fixture harness exists for persisted localStorage sample matrix in current repo;manual_test:1) set localStorage mangatype_live_settings_v1 with endpoint missing fields 2) reload app and verify defaults backfilled 3) repeat with dirty fields and complete fields to confirm stable normalized values;evidence:npx tsc --noEmit passed; npm run build passed; normalization path is deterministic and idempotent;risk:medium migration logic touches persisted endpoint settings and should be smoke-checked in browser;done_at:2026-03-01"
"APRSM-020","P0","3","backend","定义统一保护事件协议与失败分类","建立统一事件模型与失败分类枚举，约束停用原因优先级与展示来源，避免多处各自判定。","事件类型全集可被类型系统覆盖；失败分类映射无重叠；停用原因优先级可复现且稳定。","AUTOSERVER","评审事件 schema 的可扩展性与向后兼容，确认未知失败有兜底分类。","构造 HTTP 与解析失败混合场景，验证最终 disable reason 符合优先级规则且稳定。","已完成","已完成","已完成","已提交","","D:\A1\mangatype-live\services\apiProtection.ts:1;D:\A1\mangatype-live\services\geminiService.ts:1;D:\A1\mangatype-live\plan\2026-03-01_16-30-00-report-reducer-state-machine.md:13","picked_reason:P0 define canonical failure/event contract before reducer and queue integration;review_initial:added typed protection event schema, explicit failure code set with UNKNOWN fallback, deterministic disable-reason priority and unified classification entrypoint;validation_limited:no automated regression harness for mixed HTTP and parse failure sequence in this repo;manual_test:1) run app with API protection enabled 2) trigger repeated HTTP 429/503 and invalid bubbles parse errors 3) verify disable reason code remains deterministic by priority when mixed failures occur;evidence:parse failures now carry PARSE_BUBBLES_INVALID code from gemini parsing path; apiProtection classification and priority constants centralized; npx tsc --noEmit and npm run build passed;risk:medium message-based fallback heuristics should be observed with production-like provider errors;done_at:2026-03-01"
"APRSM-030","P0","4","backend","实现 reducer 状态机单入口转移","在独立模块实现纯函数 reducer，统一暂停、降并发、恢复、停用状态转移并按批次累计失败。","表驱动单测覆盖关键转移；批次失败仅 +1；首次失败降并发到1；degraded 成功后恢复用户并发并清理计数。","AUTOSERVER","评审 reducer 纯度、无副作用、分支覆盖与可审计日志字段。","注入连续失败/恢复/阈值停用序列，验证状态转移与计数无跳阶和无遗漏。","已完成","已完成","已完成","已提交","","D:\A1\mangatype-live\services\apiProtection.ts:1;D:\A1\mangatype-live\plan\2026-03-01_16-30-00-report-reducer-state-machine.md:17;D:\A1\mangatype-live\services\apiProtectionReducer.ts:1;D:\A1\mangatype-live\services\apiProtectionReducer.test.ts:1","picked_reason:P0 state-machine reducer is prerequisite for deterministic queue-based protection transitions;review_initial:implemented pure reducer with single entry transitions for batch_failed/batch_succeeded/pause_expired/manual enable-disable and no side effects;evidence:table-driven reducer tests passed via npx --yes tsx services/apiProtectionReducer.test.ts (4 cases); npx tsc --noEmit passed; npm run build passed;acceptance:batch failure increments only +1 per batch, first failure degrades to effectiveConcurrency=1, degraded success restores user concurrency and clears counters;risk:low reducer is isolated and covered by executable cases;done_at:2026-03-01"
"APRSM-040","P0","5","backend","引入 endpoint 事件队列与 event_seq 门控","为每个 endpoint 建立串行事件消费队列，所有保护更新统一走 dispatch 并按 event_seq 丢弃过期事件。","并发下同 endpoint 无并行写入；过期事件被丢弃且有可观测日志；慢请求回写不再覆盖新状态。","AUTOSERVER","评审队列生命周期、异常处理、内存释放和 endpoint 销毁场景，禁止旁路写状态。","通过乱序返回和延迟注入回归，验证最终状态由最新序号决定且无竞争覆盖。","已完成","已完成","已完成","已提交","","D:\A1\mangatype-live\hooks\useProcessor.ts:1;D:\A1\mangatype-live\services\apiProtection.ts:1;D:\A1\mangatype-live\plan\2026-03-01_16-30-00-report-reducer-state-machine.md:21;D:\A1\mangatype-live\services\apiProtectionEventQueue.test.ts:1","picked_reason:P0 eliminate endpoint state write races before scheduler batch-loop refactor;review_initial:added per-endpoint serial protection event queue with event_seq gate, stale-event drop logs, and prune/clear lifecycle APIs;review_regression:useProcessor endpoint protection updates now dispatch through queue only, removing direct parallel writes;evidence:npx --yes tsx services/apiProtectionEventQueue.test.ts passed (stale drop + seq gate); npx --yes tsx services/apiProtectionReducer.test.ts passed; npx tsc --noEmit passed; npm run build passed;risk:medium queue ordering now governs endpoint state writes and should be smoke-observed under heavy concurrent failures;done_at:2026-03-01"
"APRSM-050","P0","6","both","调度器改造为端点级批次循环","将流式 worker 分派改为 endpoint 组批并在 awaitSettled 后派发批次事件，再决策下一批。","首批10并发全429仅计1次批次失败并触发暂停；二批并发1成功后恢复用户并发；吞吐不低于重构前基线阈值。","AUTOE2E","评审批次边界定义、饥饿风险与吞吐监控指标，确认失败计数语义已从请求级切到批次级。","执行 1 endpoint 并发10与混合成功失败场景，核对计数、暂停时长、恢复行为与性能曲线。","已完成","已完成","已完成","已提交","","D:\A1\mangatype-live\hooks\useProcessor.ts:1;D:\A1\mangatype-live\services\geminiService.ts:1;D:\A1\mangatype-live\plan\2026-03-01_16-30-00-report-reducer-state-machine.md:25;D:\A1\mangatype-live\types.ts:1;D:\A1\mangatype-live\services\apiProtectionReducer.ts:1","picked_reason:P0 scheduler batch semantics are core behavior change for request-level to batch-level protection;review_initial:translate scheduler switched to endpoint batch loop (per-endpoint effectiveConcurrency dispatch, await allSettled, then batch-level protection event dispatch);review_regression:batch failure now derives from protectable failures only and dispatches reducer BATCH_FAILED once per endpoint batch, with BATCH_SUCCEEDED restoring mode/concurrency;validation_limited:throughput baseline threshold could not be benchmarked in current CLI-only environment without representative workload/profile data;manual_test:1) run app with single endpoint concurrency=10 and induce all 429 in first batch 2) verify consecutiveBatchFailures increments to 1 and effectiveConcurrency drops to 1 after pause 3) let next batch succeed and verify effectiveConcurrency restores to user setting 4) compare throughput against pre-change baseline scenario;evidence:npx tsc --noEmit passed; reducer and event-queue tests passed via tsx; npm run build passed;risk:medium scheduler logic changed for translate path and needs browser/e2e throughput smoke;done_at:2026-03-01;scope_change:implemented rolling-fill epoch semantics requested in follow-up (no idle waiting for full allSettled batch);epoch_behavior:requests stay in same epoch until first protectable error, then endpoint trips once, aborts same-endpoint in-flight requests, pauses, and resumes next epoch after pause;debounce:epoch gate avoids duplicate failure increments in same wave and event_seq queue still prevents stale writeback overwrite;validation_limited:no deterministic integration harness for forced abort timing across provider networks;manual_test:1) V2 ON + endpoint U10 2) verify slots refill immediately while no protectable error 3) inject first 429 and verify in-flight abort + single failure increment + pause 4) after pause verify resumed requests belong to next epoch;evidence:npx tsc --noEmit passed; npm run build passed; classification/reducer/queue tests passed;done_at:2026-03-01"
"APRSM-060","P1","7","frontend","ProviderTab 移除测试工具入口与模拟测试逻辑","移除 ProviderTab 中“显示测试工具”入口与模拟 429/报错测试 UI 及其实现代码，避免伪测试路径干扰真实保护行为验证。","设置页不再出现“显示测试工具”开关与测试面板；项目内无 testEndpointProtection/formatTestResults 调用；相关配置字段移除后应用可正常构建与运行。","AUTOFRONTEND","评审 ProviderTab 与配置类型/默认值变更边界，确认仅删除测试工具路径且不影响端点编辑、启停与保护设置。","回归端点增删改、启停、保护设置重置与列表展示，确认无测试工具残留且 UI 交互正常。","已完成","已完成","已完成","已提交","","D:\A1\mangatype-live\components\settings\ProviderTab.tsx:1;D:\A1\mangatype-live\types.ts:1;D:\A1\mangatype-live\contexts\ProjectContext.tsx:1;D:\A1\mangatype-live\API_PROTECTION.md:35","picked_reason:depends for APRSM-070 UI regression coverage and completes visible disable/effective-concurrency behavior;review_initial:ProviderTab now decouples disabled reason display from pause status and surfaces user/effective concurrency at summary and row level;review_regression:enable actions reset disable reason and restore effective concurrency baseline to prevent stale UI state;validation_limited:no browser automation framework is configured for endpoint UI state transition assertions;manual_test:1) trigger endpoint auto-disable and wait for pause expiry 2) confirm Disabled reason remains visible while pause badge disappears 3) manually enable endpoint and verify reason cleared and U/E concurrency display updates;evidence:npx tsc --noEmit passed; npm run build passed; reducer/event-queue tests passed;risk:low UI-only changes but should be smoke-checked in browser for copy and state timing;done_at:2026-03-01;picked_reason:follow-up requirement explicitly removes misleading mock test tool from endpoint settings to keep UX aligned with real provider behavior;review_initial:removed ProviderTab mock test toggle/panel and deleted apiProtectionTest module without changing endpoint CRUD, enable/disable, or protection-setting flows;review_regression:static regression on endpoint settings plus compile/build checks show no runtime dependency on removed test tool path;validation_limited:browser-level interaction regression cannot be executed in current CLI-only environment;manual_test:1) open Settings > API Endpoints > protection settings and confirm no Show Test Tool toggle 2) confirm endpoint list and enable/disable/edit still work 3) confirm reset protection settings still works;evidence:npx tsc --noEmit passed; npm run build passed; runtime files no longer reference showApiProtectionTest/testEndpointProtection/formatTestResults;risk:low removal-only scope in settings UI/config with quick browser smoke recommended;done_at:2026-03-01"
"APRSM-070","P0","8","both","补齐单元与集成回归测试矩阵","新增 reducer 表驱动单测、批次语义集成验证与 UI 验证，覆盖429与解析失败保护链路。","reducer 关键分支覆盖率达团队阈值；429与 PARSE_BUBBLES_INVALID 都触发同等保护；停用原因展示回归通过。","AUTOE2E","评审测试命名、夹具可复用性与失败可诊断性，避免用例依赖脆弱时序。","执行全量回归并保存基线结果，确认无跨模块回归与无随机失败。","已完成","已完成","已完成","已提交","","D:\A1\mangatype-live\services\apiProtection.ts:1;D:\A1\mangatype-live\components\settings\ProviderTab.tsx:1;D:\A1\mangatype-live\plan\2026-03-01_16-30-00-report-reducer-state-machine.md:33;D:\A1\mangatype-live\services\apiProtectionClassification.test.ts:1;D:\A1\mangatype-live\plan\2026-03-01_16-30-00-report-reducer-state-machine-test-baseline.md:1","picked_reason:P0 consolidate executable regression matrix after core reducer/queue/scheduler/ui changes;review_initial:added executable classification parity test and baseline record document for regression command set;review_regression:executed classification + reducer + event-queue tests and compile/build checks as matrix baseline;validation_limited:UI disable-reason persistence path remains manual because no frontend test harness is configured;manual_test:1) auto-disable endpoint 2) wait pause expiry 3) confirm disable reason remains visible 4) re-enable and verify reason clears;evidence:npx --yes tsx services/apiProtectionClassification.test.ts passed; npx --yes tsx services/apiProtectionReducer.test.ts passed; npx --yes tsx services/apiProtectionEventQueue.test.ts passed; npx tsc --noEmit passed; npm run build passed;risk:low automated backend regression strengthened, UI regression still manual;done_at:2026-03-01"
"APRSM-080","P1","9","backend","发布开关与回滚路径落地","增加 apiProtectionStateMachineV2 功能开关用于灰度，提供快速回滚到旧逻辑的可执行路径。","开关可在运行时/配置层生效；灰度启用可观测；回滚后旧字段读取正常且不破坏现有 endpoint 配置。","AUTOSERVER","评审开关默认值、灰度粒度、监控告警和回滚步骤文档完整性。","执行开关开/关与回滚演练，验证数据兼容、服务可用与用户可感知风险可控。","已完成","已完成","已完成","已提交","","D:\A1\mangatype-live\services\apiProtection.ts:1;D:\A1\mangatype-live\contexts\ProjectContext.tsx:1;D:\A1\mangatype-live\plan\2026-03-01_16-30-00-report-reducer-state-machine.md:37;D:\A1\mangatype-live\components\settings\ProviderTab.tsx:1;D:\A1\mangatype-live\hooks\useProcessor.ts:1;D:\A1\mangatype-live\plan\2026-03-01_16-30-00-report-reducer-state-machine-rollback.md:1","picked_reason:P1 final rollout safety net with runtime fallback after core refactor landed;review_initial:added aiProtectionStateMachineV2 config flag (default false), runtime toggle in ProviderTab, and translate scheduler branching to legacy or V2 path based on flag;review_regression:added rollback runbook and preserved endpoint field compatibility across modes;validation_limited:no automated browser test harness to assert runtime toggle UX and end-to-end rollback behavior;manual_test:1) toggle State Machine V2 Canary on and run translate batch 2) toggle off and run translate batch 3) verify legacy request-level path is active and endpoint settings remain readable;evidence:npx tsc --noEmit passed; classification/reducer/event-queue tests passed; npm run build passed;risk:medium mode switch is runtime-critical and should be smoke-validated in browser before rollout;done_at:2026-03-01"
