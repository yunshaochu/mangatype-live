# API 保护功能更新总结

## 修改内容

### 1. 暂停时间调整
- 第 4 次错误暂停时间：4分钟 → **5分钟**
- 完整序列：30秒 → 1分钟 → 2分钟 → **5分钟** → 10分钟

### 2. 二级设置面板
在 Settings → API Endpoints 页面，点击右上角的 **⚙️ 齿轮图标** 打开高级设置。

#### 可配置项：

**启用 API 保护** (默认：开启)
- 总开关，可以完全禁用保护功能

**自动停用阈值** (默认：5，范围：1-10)
- 设置第几次连续错误后自动停用端点
- **动态控制**：修改阈值会自动调整暂停时间数量
- 例如设为 3，则只需配置 3 个暂停时间
- 例如设为 8，则需配置 8 个暂停时间

**暂停时间（秒）** (默认：30, 60, 120, 300, 600)
- **动态数量**：输入框数量 = 停用阈值
- 分别对应第 1、2、3... 次错误的暂停时间
- 最小值：1秒
- 用户可以自定义任意时长
- 增加阈值时，新增的暂停时间自动填充最后一个值
- 减少阈值时，多余的暂停时间自动移除

**显示测试工具** (默认：关闭)
- 控制是否在主界面显示 API 保护测试工具
- 关闭后测试工具会隐藏，避免界面混乱

**恢复默认设置** 按钮
- 一键恢复所有设置到默认值
- 包括：启用状态、阈值（5次）、暂停时间（5个）、测试工具开关

### 3. 测试工具控制
- 测试工具默认隐藏
- 需要在二级设置中打开 "显示测试工具" 开关
- 测试会使用用户自定义的暂停时间和停用阈值

## 使用流程

### 基础使用（使用默认配置）
1. 无需任何配置，API 保护自动工作
2. 遇到 429/503 错误时自动暂停
3. 第 5 次连续错误自动停用端点

### 自定义配置
1. 打开 Settings → API Endpoints
2. 点击右上角 ⚙️ 齿轮图标
3. 调整暂停时间（例如改为更激进的 10, 20, 40, 80, 160 秒）
4. 调整停用阈值（例如改为 3 次就停用）
5. 关闭弹窗，配置自动保存

### 测试验证
1. 在二级设置中打开 "显示测试工具"
2. 返回主界面，展开 "API 保护测试工具" 面板
3. 选择端点，运行测试场景
4. 观察暂停时间是否符合自定义配置
5. 测试完成后可以关闭测试工具开关

## 配置示例

### 保守配置（适合免费 API）
```
暂停时间：60, 180, 300, 600, 1200 (1m, 3m, 5m, 10m, 20m)
停用阈值：3
说明：更长的暂停时间，更早停用，避免封号
```

### 激进配置（适合付费 API）
```
暂停时间：10, 20, 30, 60, 120 (10s, 20s, 30s, 1m, 2m)
停用阈值：10
说明：更短的暂停时间，更晚停用，快速恢复
```

### 默认配置（平衡）
```
暂停时间：30, 60, 120, 300, 600 (30s, 1m, 2m, 5m, 10m)
停用阈值：5
说明：适合大多数场景的平衡配置
```

## 技术实现

### 文件修改
- `types.ts` - 添加配置字段
- `services/apiProtection.ts` - 支持自定义配置
- `hooks/useProcessor.ts` - 传递配置到保护逻辑
- `contexts/ProjectContext.tsx` - 默认配置
- `components/settings/ProviderTab.tsx` - 二级设置 UI

### 数据持久化
- 所有配置保存在 localStorage
- 键名：`mangatype_live_settings_v1`
- 跨会话保持配置

### 配置优先级
1. 用户自定义配置（localStorage）
2. 默认配置（代码中定义）
3. 如果用户配置无效，回退到默认值
